!function(r,i){function s(t){return 0<t&&0==(t-1&t)}var o=[1,0,0,0,1,0,0,0,1],n=function(t,e){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],f=t[7],t=t[8],c=e[0],u=e[1],h=e[2],d=e[3],p=e[4],g=e[5],m=e[6],v=e[7],x=e[8];e[0]=c*r+d*i+m*o,e[1]=u*r+p*i+v*o,e[2]=h*r+g*i+x*o,e[3]=c*n+d*a+m*s,e[4]=u*n+p*a+v*s,e[5]=h*n+g*a+x*s,e[6]=c*l+d*f+m*t,e[7]=u*l+p*f+v*t,e[8]=h*l+g*f+x*t};function a(t){return this.clearStack(t)}a.prototype.clearStack=function(t){this.m_stack=[],this.m_cache=[],this.c_stack=0,this.valid=0,this.result=null;for(var e=0;e<16;e++)this.m_stack[e]=this.getIdentity();t!==i?this.m_stack[0]=t:this.setIdentity()},a.prototype.setIdentity=function(){this.m_stack[this.c_stack]=this.getIdentity(),this.valid===this.c_stack&&this.c_stack&&this.valid--},a.prototype.getIdentity=function(){return[1,0,0,0,1,0,0,0,1]},a.prototype.getResult=function(){if(!this.c_stack)return this.m_stack[0];var t=o;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var e=this.valid;e<this.c_stack+1;e++)t=n(this.m_stack[e],t),this.m_cache[e]=t;return this.valid=this.c_stack-1,this.result=this.m_cache[this.c_stack],this.result},a.prototype.pushMatrix=function(){this.c_stack++,this.m_stack[this.c_stack]=this.getIdentity()},a.prototype.popMatrix=function(){0!==this.c_stack&&this.c_stack--};var l=a.prototype.getIdentity(),f=(a.prototype.translate=function(t,e){l[6]=t,l[7]=e,n(l,this.m_stack[this.c_stack])},a.prototype.getIdentity()),c=(a.prototype.scale=function(t,e){f[0]=t,f[4]=e,n(f,this.m_stack[this.c_stack])},a.prototype.getIdentity()),u=(a.prototype.rotate=function(t){var e=r.sin(-t),t=r.cos(-t);c[0]=t,c[3]=e,c[1]=-e,c[4]=t,n(c,this.m_stack[this.c_stack])},this.WebGL2D=function(e,t){var r;this.canvas=e,this.options=t||{},this.gl=i,this.fs=i,this.vs=i,this.shaderProgram=i,this.transform=new a,this.shaderPool=[],this.maxTextureSize=i,e.gl2d=this,e.$getContext=e.getContext,e.getContext=(r=this,function(t){return!r.options.force&&"webgl-2d"!==t||0===e.width||0===e.height?r.canvas.$getContext(t):r.gl||(t=r.gl=r.canvas.$getContext("experimental-webgl"),r.initShaders(),r.initBuffers(),r.initCanvas2DAPI(),t.viewport(0,0,r.canvas.width,r.canvas.height),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT),t.colorMask(1,1,1,0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),r.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t)}),this.postInit()});u.enable=function(t,e){return t.gl2d||new u(t,e)};var R,h,P=1,C=2,e=(u.prototype.getFragmentShaderSource=function(t){return["#ifdef GL_ES","precision highp float;","#endif","#define hasTexture "+(t&P?"1":"0"),"#define hasCrop "+(t&C?"1":"0"),"varying vec4 vColor;","#if hasTexture","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","#if hasCrop","uniform vec4 uCropSource;","#endif","#endif","void main(void) {","#if hasTexture","#if hasCrop","gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy);","#else","gl_FragColor = texture2D(uSampler, vTextureCoord);","#endif","#else","gl_FragColor = vColor;","#endif","}"].join("\n")},u.prototype.getVertexShaderSource=function(t,e){var r=2/this.canvas.width,i=-2/this.canvas.height;return["#define hasTexture "+(e&P?"1":"0"),"attribute vec4 aVertexPosition;","#if hasTexture","varying vec2 vTextureCoord;","#endif","uniform vec4 uColor;","uniform mat3 uTransforms["+(t=t||1)+"];","varying vec4 vColor;","const mat4 pMatrix = mat4("+r+",0,0,0, 0,"+i+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);","mat3 crunchStack(void) {","mat3 result = uTransforms[0];","for (int i = 1; i < "+t+"; ++i) {","result = uTransforms[i] * result;","}","return result;","}","void main(void) {","vec3 position = crunchStack() * vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = uColor;","#if hasTexture","vTextureCoord = aVertexPosition.zw;","#endif","}"].join("\n")},u.prototype.initShaders=function(t,e){var r=this.gl,i=(e=e||0,this.shaderPool[t=t||1]);if(i=(i=i||(this.shaderPool[t]=[]))[e])return r.useProgram(i),this.shaderProgram=i;i=this.fs=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(this.fs,this.getFragmentShaderSource(e)),r.compileShader(this.fs),!r.getShaderParameter(this.fs,r.COMPILE_STATUS))throw"fragment shader error: "+r.getShaderInfoLog(this.fs);var o=this.vs=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(this.vs,this.getVertexShaderSource(t,e)),r.compileShader(this.vs),!r.getShaderParameter(this.vs,r.COMPILE_STATUS))throw"vertex shader error: "+r.getShaderInfoLog(this.vs);var n=this.shaderProgram=r.createProgram();if(n.stackDepth=t,r.attachShader(n,i),r.attachShader(n,o),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS))throw"Could not initialise shaders.";r.useProgram(n),n.vertexPositionAttribute=r.getAttribLocation(n,"aVertexPosition"),r.enableVertexAttribArray(n.vertexPositionAttribute),n.uColor=r.getUniformLocation(n,"uColor"),n.uSampler=r.getUniformLocation(n,"uSampler"),n.uCropSource=r.getUniformLocation(n,"uCropSource"),n.uTransforms=[];for(var a=0;a<t;++a)n.uTransforms[a]=r.getUniformLocation(n,"uTransforms["+a+"]");return this.shaderPool[t][e]=n},new Float32Array([0,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0]));u.prototype.initBuffers=function(){var t=this.gl;R=t.createBuffer(),t.createBuffer(),h=t.createBuffer(),t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,R),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW)},u.instances=[],u.prototype.postInit=function(){u.instances.push(this)},u.prototype.initCanvas2DAPI=function(){var d=this,p=this.gl,t=document.createElement("canvas"),e=(t.width=d.canvas.width,t.height=d.canvas.height,t.getContext("2d")),g=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/,m=/^hsl(a)?\(\s*(-?[\d\.]+)\s*,\s*(-?[\d\.]+)%\s*,\s*(-?[\d\.]+)%\s*,?\s*(-?[\d\.]+)?\s*\)$/,v=/^#([0-9A-Fa-f]{6})$/,x=/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/;function T(t){var e,r,i,o,n,a,s,l,f,c=[];if(e=g.exec(t)){if(s=e[1],d=parseFloat(e[8]),s&&isNaN(d)||!s&&!isNaN(d))return!1;for(var u=e[3],h=2;h<8;h+=2){if(r=e[h],(i=e[h+1])!==u)return!1;r=i?(r=100<r?1:r/100)<0?0:r:(r=255<r?1:r/255)<0?0:r,c.push(r)}c.push(s?d:1)}else if(e=m.exec(t))s=e[1],d=parseFloat(e[5]),o=e[2],n=e[3],a=e[4],s=parseFloat(s&&d?d:1),n=(n=100<n?1:n/100)<0?0:n,l=2*(a=(a=100<a?1:a/100)<0?0:a)-(f=a<=.5?a*(n+1):a+n-a*n),c=[p((o=(o%360+360)%360/360)+1/3),p(o),p(o-1/3),s];else if(e=v.exec(t))var d=parseInt(e[1],16),c=[((16711680&d)>>16)/255,((65280&d)>>8)/255,(255&d)/255,1];else if(e=x.exec(t))c=T("#"+[e[1],e[1],e[2],e[2],e[3],e[3]].join(""));else{if("transparent"!==t.toLowerCase())return!1;c=[0,0,0,0]}function p(t){t=6*t<1?l+(f-l)*t*6:2*t<1?f:3*t<2?l+(f-l)*(2/3-t)*6:l;return t}return c}function r(t){return"rgba("+255*t[0]+", "+255*t[1]+", "+255*t[2]+", "+parseFloat(t[3])+")"}var a={},i=[];a.fillStyle=[0,0,0,1],Object.defineProperty(p,"fillStyle",{get:function(){return r(a.fillStyle)},set:function(t){a.fillStyle=T(t)||a.fillStyle}}),a.strokeStyle=[0,0,0,1],Object.defineProperty(p,"strokeStyle",{get:function(){return r(a.strokeStyle)},set:function(t){a.strokeStyle=T(t)||drawStyle.strokeStyle}}),p.$lineWidth=p.lineWidth,a.lineWidth=1,Object.defineProperty(p,"lineWidth",{get:function(){return a.lineWidth},set:function(t){p.$lineWidth(t),a.lineWidth=t}}),a.lineCap="butt",Object.defineProperty(p,"lineCap",{get:function(){return a.lineCap},set:function(t){a.lineCap=t}}),a.lineJoin="miter",Object.defineProperty(p,"lineJoin",{get:function(){return a.lineJoin},set:function(t){a.lineJoin=t}}),a.miterLimit=10,Object.defineProperty(p,"miterLimit",{get:function(){return a.miterLimit},set:function(t){a.miterLimit=t}}),a.shadowOffsetX=0,Object.defineProperty(p,"shadowOffsetX",{get:function(){return a.shadowOffsetX},set:function(t){a.shadowOffsetX=t}}),a.shadowOffsetY=0,Object.defineProperty(p,"shadowOffsetY",{get:function(){return a.shadowOffsetY},set:function(t){a.shadowOffsetY=t}}),a.shadowBlur=0,Object.defineProperty(p,"shadowBlur",{get:function(){return a.shadowBlur},set:function(t){a.shadowBlur=t}}),a.shadowColor="rgba(0, 0, 0, 0.0)",Object.defineProperty(p,"shadowColor",{get:function(){return a.shadowColor},set:function(t){a.shadowColor=t}}),a.font="10px sans-serif",Object.defineProperty(p,"font",{get:function(){return a.font},set:function(t){e.font=t,a.font=t}}),a.textAlign="start",Object.defineProperty(p,"textAlign",{get:function(){return a.textAlign},set:function(t){a.textAlign=t}}),a.textBaseline="alphabetic",Object.defineProperty(p,"textBaseline",{get:function(){return a.textBaseline},set:function(t){a.textBaseline=t}}),a.globalAlpha=1,Object.defineProperty(p,"globalAlpha",{get:function(){return a.globalAlpha},set:function(t){a.globalAlpha=t}}),a.globalCompositeOperation="source-over",Object.defineProperty(p,"globalCompositeOperation",{get:function(){return a.globalCompositeOperation},set:function(t){a.globalCompositeOperation=t}}),p.fillText=function(t,e,r){},p.strokeText=function(){},p.measureText=function(){return 1};var S=document.createElement("canvas").getContext("2d");function _(t){for(var e=d.transform.m_stack,r=0,i=d.transform.c_stack+1;r<i;++r)p.uniformMatrix3fv(t.uTransforms[r],!1,e[i-1-r])}p.save=function(){var t;d.transform.pushMatrix(),t={fillStyle:[a.fillStyle[0],a.fillStyle[1],a.fillStyle[2],a.fillStyle[3]],strokeStyle:[a.strokeStyle[0],a.strokeStyle[1],a.strokeStyle[2],a.strokeStyle[3]],globalAlpha:a.globalAlpha,globalCompositeOperation:a.globalCompositeOperation,lineCap:a.lineCap,lineJoin:a.lineJoin,lineWidth:a.lineWidth,miterLimit:a.miterLimit,shadowColor:a.shadowColor,shadowBlur:a.shadowBlur,shadowOffsetX:a.shadowOffsetX,shadowOffsetY:a.shadowOffsetY,textAlign:a.textAlign,font:a.font,textBaseline:a.textBaseline},i.push(t)},p.restore=function(){d.transform.popMatrix(),i.length&&(a=i.pop())},p.translate=function(t,e){d.transform.translate(t,e)},p.rotate=function(t){d.transform.rotate(t)},p.scale=function(t,e){d.transform.scale(t,e)},p.createImageData=function(t,e){return S.createImageData(t,e)},p.getImageData=function(t,e,r,i){for(var o=S.createImageData(r,i),n=new Uint8Array(r*i*4),a=(p.readPixels(t,e,r,i,p.RGBA,p.UNSIGNED_BYTE,n),4*r),s=i,l=0,f=s/2;l<f;++l)for(var c=0,u=a;c<u;++c){var h=l*a+c,d=(s-l-1)*a+c;o.data[h]=n[d],o.data[d]=n[h]}return o},p.putImageData=function(t,e,r){p.drawImage(t,e,r)},p.transform=function(t,e,r,i,o,n){var a=d.transform.m_stack[d.transform.c_stack];a[0]*=t,a[1]*=r,a[2]*=o,a[3]*=e,a[4]*=i,a[5]*=n,a[6]=0,a[7]=0},p.setTransform=function(t,e,r,i,o,n){d.transform.setIdentity(),p.transform.apply(this,arguments)},p.fillRect=function(t,e,r,i){var o=d.transform,n=d.initShaders(o.c_stack+2,0);p.bindBuffer(p.ARRAY_BUFFER,R),p.vertexAttribPointer(n.vertexPositionAttribute,4,p.FLOAT,!1,0,0),o.pushMatrix(),o.translate(t,e),o.scale(r,i),_(n),p.uniform4f(n.uColor,a.fillStyle[0],a.fillStyle[1],a.fillStyle[2],a.fillStyle[3]),p.drawArrays(p.TRIANGLE_FAN,0,4),o.popMatrix()},p.strokeRect=function(t,e,r,i){var o=d.transform,n=d.initShaders(o.c_stack+2,0);p.bindBuffer(p.ARRAY_BUFFER,R),p.vertexAttribPointer(n.vertexPositionAttribute,4,p.FLOAT,!1,0,0),o.pushMatrix(),o.translate(t,e),o.scale(r,i),_(n),p.uniform4f(n.uColor,a.strokeStyle[0],a.strokeStyle[1],a.strokeStyle[2],a.strokeStyle[3]),p.drawArrays(p.LINE_LOOP,0,4),o.popMatrix()},p.clearRect=function(t,e,r,i){};var n=[];function o(t,e){this.closed=!1,this.verts=[t,e,0,0]}p.beginPath=function(){n.length=0},p.closePath=function(){var t,e,r;n.length&&(t=(r=n[n.length-1]).verts[0],e=r.verts[1],r.closed=!0,r=new o(t,e),n.push(r))},p.moveTo=function(t,e){n.push(new o(t,e))},p.lineTo=function(t,e){n.length?n[n.length-1].verts.push(t,e,0,0):p.moveTo(t,e)},p.quadraticCurveTo=function(t,e,r,i){},p.bezierCurveTo=function(t,e,r,i,o,n){},p.arcTo=function(){},p.rect=function(t,e,r,i){p.moveTo(t,e),p.lineTo(t+r,e),p.lineTo(t+r,e+i),p.lineTo(t,e+i),p.closePath()},p.arc=function(t,e,r,i,o,n){},p.fill=function(){for(var t,e,r,i=0;i<n.length;i++)t=i,r=e=void 0,e=d.transform,r=d.initShaders(e.c_stack+2,0),t=n[t].verts,p.bindBuffer(p.ARRAY_BUFFER,h),p.bufferData(p.ARRAY_BUFFER,new Float32Array(t),p.STATIC_DRAW),p.vertexAttribPointer(r.vertexPositionAttribute,4,p.FLOAT,!1,0,0),e.pushMatrix(),_(r),p.uniform4f(r.uColor,a.fillStyle[0],a.fillStyle[1],a.fillStyle[2],a.fillStyle[3]),p.drawArrays(p.TRIANGLE_FAN,0,t.length/4),e.popMatrix()},p.stroke=function(){for(var t,e,r,i,o=0;o<n.length;o++)t=o,i=r=e=void 0,e=d.transform,r=d.initShaders(e.c_stack+2,0),i=(t=n[t]).verts,p.bindBuffer(p.ARRAY_BUFFER,h),p.bufferData(p.ARRAY_BUFFER,new Float32Array(i),p.STATIC_DRAW),p.vertexAttribPointer(r.vertexPositionAttribute,4,p.FLOAT,!1,0,0),e.pushMatrix(),_(r),p.uniform4f(r.uColor,a.strokeStyle[0],a.strokeStyle[1],a.strokeStyle[2],a.strokeStyle[3]),t.closed?p.drawArrays(p.LINE_LOOP,0,i.length/4):p.drawArrays(p.LINE_STRIP,0,i.length/4),e.popMatrix()},p.clip=function(){},p.isPointInPath=function(){},p.drawFocusRing=function(){};var A=[],y=[];function E(t){var e;this.obj=p.createTexture(),this.index=y.push(this),A.push(t),(t.width>d.maxTextureSize||t.height>d.maxTextureSize)&&((e=document.createElement("canvas")).width=t.width>d.maxTextureSize?d.maxTextureSize:t.width,e.height=t.height>d.maxTextureSize?d.maxTextureSize:t.height,e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e),p.bindTexture(p.TEXTURE_2D,this.obj),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,t),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR),s(t.width)&&s(t.height)?(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR_MIPMAP_LINEAR),p.generateMipmap(p.TEXTURE_2D)):p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR),p.bindTexture(p.TEXTURE_2D,null)}p.drawImage=function(t,e,r,i,o,n,a,s,l){var f=d.transform,c=(f.pushMatrix(),P),u=!1,c=(3===arguments.length?(f.translate(e,r),f.scale(t.width,t.height)):5===arguments.length?(f.translate(e,r),f.scale(i,o)):9===arguments.length&&(f.translate(n,a),f.scale(s,l),c|=C,u=!0),d.initShaders(f.c_stack,c)),h=A.indexOf(t),h=-1!==h?y[h]:new E(t);u&&p.uniform4f(c.uCropSource,e/t.width,r/t.height,i/t.width,o/t.height),p.bindBuffer(p.ARRAY_BUFFER,R),p.vertexAttribPointer(c.vertexPositionAttribute,4,p.FLOAT,!1,0,0),p.bindTexture(p.TEXTURE_2D,h.obj),p.activeTexture(p.TEXTURE0),p.uniform1i(c.uSampler,0),_(c),p.drawArrays(p.TRIANGLE_FAN,0,4),f.popMatrix()}}}(Math);